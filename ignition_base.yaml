# This file aims to provide a usable base CoreOS image which can run Encoder/Decoder/Livestreamer tasks effectively
#ignition: 
#version: 3.0.0   
variant: fcos
version: 1.5.0
storage:
  files:
# Sets hostname
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents: 
        inline: hostname.test.local
# Skel
    - path: /etc/skel/.bashrc
      mode: 420
      overwrite: true
      contents: 
        source: https://andymelville.net/wavelet/public/skel.txt
# Udev_rules (ENCODER but installed on all boxes anyway)
    - path: /etc/udev/rules.d/80-wavelet-encoder.rules
      mode: 420
      overwrite: true
      contents:
        source: https://andymelville.net/wavelet/public/80-wavelet-encoder.rules
#	udev_call  (required otherwise udev blocks /dev/ tree access until trigger is complete)
#	DetectV4l  (attempts to intelligently manage v4l devices with symlinks)

passwd: 
  users:
    - name: wavelet-root
      uid: 9337
      password_hash: '$6$nP0Rno68wE$kLZixz9bqOzUspYONNXvH21razOeqkkxo.325Q1pfWtuHWoSAHaoUVrbJ0oqYYjO7f4/Qs5U5HOpm2n6WFASO0'
      home_dir: /home/wavelet-root
    - name: wavelet
      uid: 1337
      password_hash: $6$0OV84d.JPTnYjv02$i8JnR90kRViFcTwjPKTB3g7p99DpIux8PJBI2n2ToNvcI7Epb1T2vLLRuansi8WQbxaQT7Ibl/RKWtAD5Otsz0
      home_dir: /home/wavelet
      ssh_authorized_keys_local:
          - id_ed25519.pub
systemd:
  units:
    - name: install-overlayed-rpms.service
      enabled: true
      contents: |
        [Unit]
        Description=Install Required Overlay Packages
        ConditionFirstBoot=yes
        Wants=network-online.target
        After=network-online.target
        After=multi-user.target
        [Service]
        Type=oneshot
        ExecStart=rpm-ostree install vim powerline powerline-fonts vim-powerline cockpit NetworkManager-wifi iw wireless-regdb wpa_supplicant etcd --reboot
        [Install]
        WantedBy=multi-user.target
    - name: etcd-member.service
      enabled: true
      contents: |
        [Unit]
        Description=Run etcd
        After=network-online.target
        Wants=network-online.target
        [Service]
        ExecStartPre=mkdir -p /var/lib/etcd
        ExecStartPre=-/bin/podman kill etcd
        ExecStartPre=-/bin/podman rm etcd
        ExecStartPre=-/bin/podman pull quay.io/coreos/etcd
        ExecStart=/bin/podman run --name etcd --volume /var/lib/etcd:/etcd-data:z --net=host quay.io/coreos/etcd:latest /usr/local/bin/etcd --data-dir /etcd-data --name node1 \
                        --initial-advertise-peer-urls http://0.0.0.0:2380 --listen-peer-urls http://0.0.0.0:2380 \
                        --advertise-client-urls http://0.0.0.0:2379 \
                        --listen-client-urls http://0.0.0.0:2379 \
                        --initial-cluster node1=http://192.168.1.32:2380
        ExecStop=/bin/podman stop etcd
        [Install]
        WantedBy=multi-user.target
